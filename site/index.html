<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bus Camera Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }

    .custom-glow-icon {
      background: none;
      border: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    const cameraMarkers = {}; // key = camera ID, value = Leaflet marker

    function createGlowIcon(color = '#ccc', opacity = 0.5) {
      return L.divIcon({
        className: "custom-glow-icon",
        html: `<div style="
          width: 24px;
          height: 24px;
          background: ${color};
          border-radius: 50%;
          border: 2px solid #333;
          box-shadow: 0 0 10px 5px ${color};
          opacity: ${opacity};
        "></div>`
      });
    }

    async function loadCameras() {
      const response = await fetch('cameras.json');
      const cameras = await response.json();

      cameras.forEach(cam => {
        const marker = L.marker([cam.latitude, cam.longitude], {
          icon: createGlowIcon() // <-- default faint circle
        }).addTo(map);

        marker.bindPopup(`<b>${cam.name}</b><br>No buses yet`);
        cameraMarkers[cam.id] = marker;
      });
    }

    function interpolateColor(color1, color2, factor) {
      const result = color1.slice();
      for (let i = 0; i < 3; i++) {
        result[i] = Math.round(color1[i] + factor * (color2[i] - color1[i]));
      }
      return result;
    }

    function rgbToHex(rgb) {
      return '#' + rgb.map(x => {
        const hex = x.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    function getHeatmapColor(minutesAgo, maxMinutes=300) {
      const factor = Math.min(minutesAgo / maxMinutes, 1.0);
      const color = interpolateColor([0, 255, 0], [200, 200, 200], factor); // green to gray
      return rgbToHex(color);
    }

    async function loadBuses() {
      const response = await fetch('buses.json');
      const busesData = await response.json();

      for (const [camId, buses] of Object.entries(busesData)) {
        const marker = cameraMarkers[camId];
        if (marker) {
          const busCount = buses.length;
          let popupContent = `
            <b>Camera ID:</b> ${camId}<br/>
            <b>Buses detected:</b> ${busCount}<br/>
          `;

          let latestDeparture = null;
          buses.forEach(bus => {
            popupContent += `
              <hr/>
              <b>Route:</b> ${bus.route}<br/>
              <b>Arrived:</b> ${new Date(bus.arrived).toLocaleString()}<br/>
              <b>Departed:</b> ${new Date(bus.departed).toLocaleString()}<br/>
              <img src="${bus.image}" width="150" style="margin-top:5px;"><br/>
            `;

            const depTime = new Date(bus.departed);
            if (!latestDeparture || depTime > latestDeparture) {
              latestDeparture = depTime;
            }
          });

          marker.setPopupContent(popupContent);

          if (latestDeparture) {
            const minutesAgo = (Date.now() - latestDeparture.getTime()) / 60000;
            const color = getHeatmapColor(minutesAgo);
            marker.setIcon(createGlowIcon(color, 0.9)); // higher opacity when active
          }
        }
      }
    }

    async function loadRoutes() {
      const response = await fetch('routes.json');
      const routes = await response.json();

      for (const [routeId, latlngs] of Object.entries(routes)) {
        const polyline = L.polyline(latlngs, {
          color: 'gray', // you can change this if you want
          weight: 2,
          opacity: 0.6
        }).addTo(map);
        // routePolylines[routeId] = polyline;
      }
    }


    async function setup() {
      map = L.map('map').setView([40.806, -73.948], 13);

      // Use a nicer basemap (CartoDB Positron)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://carto.com/">CartoDB',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);

      await loadCameras();
      await loadRoutes();
      await loadBuses(); // initial load

      // Poll every 5 seconds for updated buses
      setInterval(loadBuses, 5000);
    }

    setup();
  </script>
</body>
</html>
